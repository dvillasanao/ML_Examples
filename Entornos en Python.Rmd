---
title: "Entorno en Python"
subtitle: "Usando reticulate"
author: "Diana Villasana Ocampo"
output:
   html_document:
      code_folding: hide
      highlight: tango
      theme: flatly
      toc: true
      toc_depth: 3
      toc_float:
        collapsed: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = FALSE,
                      cache.lazy = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = here::here())
setwd(here::here())
```

Crear un entorno en RStudio que use **Quarto**, **reticulate**, y una versi√≥n espec√≠fica de **Python** (por ejemplo, `3.13.3`) implica coordinar varias herramientas. Aqu√≠ tienes una gu√≠a clara paso a paso para que funcione bien, especialmente en un entorno como **RStudio Cloud**.



## ‚úÖ 1. Requisitos previos

### Software necesario:

* [R](https://cran.r-project.org/) (versi√≥n recomendada: ‚â• 4.2)
* [RStudio](https://posit.co/download/rstudio-desktop/) (versi√≥n ‚â• 2022.07)
* [Python](https://www.python.org/) (se recomienda usar `pyenv`, `conda` o un entorno virtual)
* [Quarto](https://quarto.org/docs/get-started/) instalado

Se puede verificar desde la consola de RStudio:

```{r}
reticulate::py_config()
```

---

## ‚úÖ 2. Instalar Quarto 

### En RStudio:

```{r}
install.packages("quarto")
quarto::quarto_path()  # Verifica si est√° instalado
```

Tambi√©n se puede instalar manualmente desde: [https://quarto.org/docs/get-started/](https://quarto.org/docs/get-started/)



## ‚úÖ 3. Instalar y configurar reticulate

```{r}
install.packages("reticulate")
require(reticulate)
```


## ‚úÖ 4. Crear un entorno virtual de Python

### Opci√≥n A: Usar `venv`

```{r}
reticulate::virtualenv_create(envname = "r-reticulate")
reticulate::use_virtualenv("r-reticulate", required = TRUE)
```

### Opci√≥n B: Usar `conda`

Si se tiene Anaconda o Miniconda instalado:

Se utiliza {reticulate} para instalar miniconda con:

```{r, eval=FALSE}
reticulate::install_miniconda()
#reticulate::install_miniconda(force = TRUE)
```


#### `reticulate::conda_create("r-reticulate")`
  
  Este comando **crea un nuevo entorno conda** llamado `"r-reticulate"` usando `reticulate`.

* Usar√° **Miniconda** (instalado previamente por `reticulate::install_miniconda()`).
* Instala la **√∫ltima versi√≥n de Python disponible por conda**.
* Crea el entorno en la ruta de conda local, t√≠picamente en:
  
  ```
~/AppData/Local/r-miniconda/envs/r-reticulate/
  ```

> üìå Este entorno queda vac√≠o (sin paquetes) salvo por Python. Puedes instalar paquetes luego con `reticulate::py_install()` o `conda install`.


#### `reticulate::use_condaenv("r-reticulate", required = TRUE)`
  
  Este comando **activa el entorno** `"r-reticulate"` dentro de la sesi√≥n de R.

* Hace que cualquier c√≥digo Python que corras desde R (por ejemplo, en un chunk de Quarto o RMarkdown) se ejecute usando ese entorno.
* `required = TRUE` significa: *‚Äúlanzar un error si no se encuentra el entorno‚Äù*, √∫til para asegurarte de que se usa el correcto.

##### üß† ¬øCu√°ndo se usa esto?
  
Esto se usa t√≠picamente para:
  
  * Crear un entorno de Python controlado solo para el proyecto R o Quarto.
* Evitar conflictos con otros entornos de Python en el sistema.
* Asegurar reproducibilidad (especialmente √∫til si se agrega al `.Rprofile` o scripts de inicializaci√≥n del proyecto).


**Precauci√≥n**: Si ya se tiene  otro entorno que se est√° usando (como `py-env`), **no se necesita crear `r-reticulate`**, a menos que se quiera uno nuevo espec√≠ficamente para este proyecto.

```{r}
reticulate::conda_create("r-reticulate")
reticulate::use_condaenv("r-reticulate", required = TRUE)
```


Se visualiza la configuraci√≥n de python: que tengo actualemente. 

```{r, eval=FALSE}
reticulate::py_config()
```

## ‚úÖ 5.  Comprobar si `reticulate` ya est√° inicializado

Se puede preguntar directamente:
  

```{r}
reticulate::py_available()

```

* `TRUE` ‚Üí hay un entorno activo y funcional
* `FALSE` ‚Üí no hay entorno activo o fall√≥ la inicializaci√≥n

**Ver entorno Conda actual (si usas conda)**

Si se quiere saber cu√°l entorno conda se est√° usando, esto lo muestra en la salida de `py_config()`, pero tambi√©n se puede hacer:
  
```{r}
Sys.getenv("CONDA_DEFAULT_ENV")
```

* Te dar√° el nombre del entorno si est√°s usando conda
* Si est√° vac√≠o (`""`), puede que no est√©s en uno o lo est√©s manejando manualmente


Se crea un nuevo conda environment, estableciendo la versi√≥n de python a utilizar: 

```{r, eval=FALSE}
reticulate::conda_create('r-reticulate', 
                         # En este caso, versi√≥n de python que tenemos en RStudio cloud:
                         python_version = '3.13.3' 
                         )
```

### Conda desde la terminal / instalaci√≥n de paquetes

Para poder ejecutar comandos desde la terminal es necesario ejecutar lo siguiente. 
Copiar el output del chunk siguiente y pegar en la terminal.   

#### Terminal 

- `conda env list` (muestre la lista de conda / BASE / r-reticulate/py-env)

Activar otro enviroment activado para despu√©s eliminarlo.    

Para activar otro enviroment:

- `activate py-env`

Instalar las paqueter√≠as en un enviromente propio para que se pueda modificar

```{r, eval=TRUE}
condash <- paste0('source ',
                   gsub('C:','',reticulate::miniconda_path()), #"C:/Users/dvill/AppData/Local/r-miniconda"
                 '/etc/profile.d/conda.sh')

condash
```

-   Se activa el environment creado:

    - `conda activate py-env`

-   Se listan los environments, visualizando que est√° seleccionado el correcto:

    - `conda env list`

-   Se instalan paquetes para probar que funciona correctamente

    - `conda install -c conda-forge numpy`

    - `conda install -c conda-forge pandas`

    - `conda install -c conda-forge scikit-learn`

O directamente en consola:

```bash
source r-reticulate/bin/activate  # si se usa venv
pip install pandas matplotlib numpy
```

## ‚úÖ 6. Configuraci√≥n del environment en Rmarkdown

Es necesario realizar un restart y luego configurar el env a utilizar. Esto es as√¨ porque al ejecutar algunas cosas python antes qued√≥ configurada otra versi√≥n. 


Por ejemplo, desde R:

```{r}
reticulate::py_install(c("pandas", "matplotlib", "numpy"), envname = "r-reticulate")
```

Se importan las librer√≠as python instaladas mediante conda en el environment creado:

```{python}
import re
import numpy as np
import pandas as pd
```


## ‚úÖ 7.  Se crea un .yml de los requerimientos del conda env

Este comando:
  
1. **Exporta** el contenido del entorno conda llamado `r-reticulate`.
2. **Guarda** toda su configuraci√≥n y dependencias (paquetes + versiones + canales conda) en un archivo YAML llamado `r-reticulate_requirements.yml`.


Ver que versiones se instalaron

- `conda env export --name r-reticulate \> r-reticulate_requirements.yml`

```{bash}
conda env export --name r-reticulate > r-reticulate_requirements.yml
```

**Qu√© incluye ese `.yml`**
  
El archivo `.yml` que se genera incluir√°:
  
  * Nombre del entorno (`name: r-reticulate`)
* Versi√≥n de Python usada
* Lista completa de paquetes instalados y sus versiones exactas
* Canales de instalaci√≥n (`conda-forge`, `defaults`, etc.)


````
```yaml
name: r-reticulate
channels:
  - defaults
dependencies:
  - python=3.10.13
- numpy=1.24.4
- pandas=1.5.3
- matplotlib=3.6.2
```
````
**Para qu√© sirve?**
  
  * ‚úÖ **Reproducibilidad:** Puedes compartir ese `.yml` con otra persona o en otro proyecto y replicar exactamente el mismo entorno.
* ‚úÖ **Backup del entorno:** Guarda un "snapshot" de tu entorno actual.
* ‚úÖ **Reinstalar f√°cilmente:** Puedes volver a crear ese entorno en otra m√°quina con:
  
```{bash}
conda env create -f r-reticulate_requirements.yml
```


Guarda el .yml en el path de getwd()

```{r}
env_req <- base::system('conda list -n r-reticulate', intern = TRUE)
```




